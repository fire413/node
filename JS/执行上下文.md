## 执行上下文

评估和执行JavaScript代码的环境的抽象概念。

三种执行上下文类型：

全局执行上下文   它执行两件事：创建全局window对象（浏览器的情况下），并设置this为这个全局对象。一个程序中只有一个。

函数执行上下文  每当函数被调用时，都会为这个函数创建一个新的上下文。每个函数都有自己的执行上下文，在函数被调用时创建。

Eval函数执行上下文  执行在eval函数内部的代码也有属于自己的上下文。

## 执行栈

“调用栈”，是一种后进先出的数据结构，用来存储代码运行时所创建的所有执行上下文。

```js
let a = 'Hello World!';

function first() {
  console.log('Inside first function');
  second();
  console.log('Again inside first function');
}

function second() {
  console.log('Inside second function');
}

first();
console.log('Inside Global Execution Context');
```

![上下文demo](E:\other\picture\上下文demo.PNG)

## 执行上下文详细过程

创建执行上下文分为两个阶段：创建阶段、执行阶段

### 创建阶段

创建阶段会发生三件事：

1.this值的指定

2.创建词法环境组件

3.创建变量环境组件

```js
ExecutionContext = {
  ThisBinding = <this value>,  //this指定
  LexicalEnvironment = { ... },  //词法环境
  VariableEnvironment = { ... },  //变量环境
}
```

#### this的指定

在全局执行上下文中，this指向全局对象。在函数执行上下文中，this的值取决于该函数是如何被调用的。如果它被一个引用对象调用，那么 `this` 会被设置成那个对象，否则 `this` 的值被设置为全局对象或者 `undefined`（在严格模式下）。

#### 词法环境

**词法环境**是一种持有**标识符—变量映射**的结构。（这里的**标识符**指的是变量/函数的名字，而**变量**是对实际对象[包含函数类型对象]或原始数据的引用）。

词法环境有两种类型：

1.全局环境：无外部环境的引用，为null。环境记录器类型是对象环境记录器。

2.函数环境：环境记录器类型是声明式环境记录器。

词法环境内部包含：环境记录器（存储变量和函数声明的实际位置）、外部环境的引用（作用域）

环境记录器也有两种类型：声明式环境记录器（存储变量、函数、参数）、对象环境记录器（出现在全局上下文中的变量和函数的关系）

注意：对于**函数环境**，**声明式环境记录器**还包含了一个传递给函数的 `arguments` 对象（此对象存储索引和参数的映射）和传递给函数的参数的 **length**。

#### 变量环境

变量环境也是一个词法环境，在 ES6 中，**词法环境**组件和**变量环境**的一个不同就是前者被用来存储函数声明和变量（`let` 和 `const`）绑定，而后者只用来存储 `var` 变量绑定。

### 执行阶段

在此阶段，完成对所有这些变量的分配，最后执行代码。

```js
let a = 20;
const b = 30;
var c;

function multiply(e, f) {
 var g = 20;
 return e * f * g;
}

c = multiply(20, 30);
```

```js
GlobalExectionContext={   // 全局执行上下文
    ThisBinding：<Global Object>, //第一步，确定this的指定
	LexicalEnvironment:{   // 第二步，创建词法环境
		EnvironmentRecord:{    // 环境记录器
			Type: "Object",   // 全局执行上下文中的环境记录器类型为对象环境记录器
			// 标识符的绑定
    		a: < uninitialized >,   // let声明
    		b: < uninitialized >,  // const声明
    		multiply: < func >   // 函数声明
		}
    	outer: <null>  // 全局执行上下文中无外部环境的引用
	},
    VariableEnviroment: {   // 第三步，创建变量环境
        EnvironmentRecord: {
            Type: "Object", // 全局执行上下文中的环境记录器类型为对象环境记录器
            // 标识符的绑定
            c: undefined,  // var声明
        },
        outer: <null> // 全局执行上下文中无外部环境的引用
    }
}
FunctionExectionContext={   // 函数执行上下文
    ThisBinding: <Global Object>,
    LexicalEnvironment: {
    	EnvironmentRecord: {
            Type: "Declarative", // 全局执行上下文中的环境记录器类型为声明式环境记录器
            Arguments: {0: 20,1: 30,length: 2},//对于函数环境，声明式环境记录器还包含了一个传递给函数的 arguments 对象（此对象存储索引和参数的映射）和传递给函数的参数的 length。
		},
         outer: <GlobalLExicalEnvironment>  // 外部环境的应用为全局上下文环境
	},
    VariableEnvironment: {
        EnvironmentRecord: {
            Type: "Declarative", // 全局执行上下文中的环境记录器类型为声明式环境记录器
            g: undefined 
        },
        outer: <GlobalLExicalEnvironment> // 外部环境的应用为全局上下文环境
    }
},
    
```
